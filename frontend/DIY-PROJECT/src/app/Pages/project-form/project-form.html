<!-- src/app/components/project-form/project-form.component.html -->
<div class="container">
  <h1 class="title">{{ isEditMode() ? 'Edit Project ' : 'Create new project' }}</h1>

  @if (loading()) {
    <mat-spinner diameter="50"></mat-spinner>
  } @else {
    <form [formGroup]="form()" (ngSubmit)="submit(form().value.isDraft)" class="form">
      <!-- כותרת -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Project Title</mat-label>
        <input matInput formControlName="title" placeholder="לדוגמה: איך לבנות רובוט מפחיות">
      </mat-form-field>

      <!-- תיאור -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Description / Introduction</mat-label>
        <textarea matInput rows="4" formControlName="description"></textarea>
      </mat-form-field>

      <!-- תמונת שער -->
      <div class="image-upload">
        <input type="file" (change)="onCoverChange($event)" accept="image/*" id="cover" hidden />
        <label for="cover" class="upload-btn">
          <mat-icon>add_photo_alternate</mat-icon>
          <span>Upload Cover Image</span>
        </label>
        @if (coverPreview()) {
          <img [src]="coverPreview()" class="preview" />
        }
      </div>

      <!-- חומרים -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Required Materials</mat-label>
        <textarea matInput rows="3" formControlName="materials"></textarea>
      </mat-form-field>

      <!-- קטגוריה -->
      <mat-form-field appearance="outline">
        <mat-label>Categories</mat-label>
        <mat-select formControlName="categoryId">
          @for (cat of categories(); track cat.id) {
            <mat-option [value]="cat.id">{{ cat.name }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <!-- גילאים + זמן -->
      <div class="row">
        <mat-form-field appearance="outline">
          <mat-label>"Age range"</mat-label>
          <input matInput formControlName="ages" placeholder="6-12">
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Preparation Time</mat-label>
          <input matInput formControlName="timePrep" placeholder="30 דקות">
        </mat-form-field>
      </div>

      <!-- תגיות -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Tags (up to 5)</mat-label>
        <mat-chip-grid #chipGrid>
          @for (tag of tags(); track tag) {
            <mat-chip (removed)="removeTag(tag)">
              {{ tag }}
              <button matChipRemove><mat-icon>cancel</mat-icon></button>
            </mat-chip>
          }
          @if (tags().length < 5) {
            <input placeholder="הוסף תגית..."
                   [matChipInputFor]="chipGrid"
                   (matChipInputTokenEnd)="addTag($event)" />
          }
        </mat-chip-grid>
        <mat-hint>{{ tags().length }}/5</mat-hint>
      </mat-form-field>

      <!-- שלבים -->
      <div formArrayName="steps" class="steps">
        @for (step of steps().controls; track $index; let i = $index) {
          <div [formGroupName]="i" class="step-card">
            <div class="step-header">
              <h3>Step {{ i + 1 }}</h3>
              <button mat-icon-button (click)="removeStep(i)" [disabled]="steps().length === 1">
                <mat-icon>delete</mat-icon>
              </button>
            </div>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Step Title</mat-label>
              <input matInput formControlName="title">
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Detailed description</mat-label>
              <textarea matInput rows="4" formControlName="content"></textarea>
            </mat-form-field>

            <div class="image-upload">
              <input type="file" (change)="onStepImageChange($event, i)" accept="image/*" [id]="'step'+i" hidden />
              <label [for]="'step'+i" class="upload-btn small">
                <mat-icon>add_photo_alternate</mat-icon>
                <span>Add image</span>
              </label>
              @if (stepPreviews()[i]) {
                <img [src]="stepPreviews()[i]" class="preview" />
              }
            </div>
          </div>
        }
      </div>

      <button mat-stroked-button color="primary" (click)="addStep()" class="add-step">
        <mat-icon>add</mat-icon> Add step
      </button>

      <!-- כפתורים -->
      <div class="actions">
        <button mat-button (click)="submit(true)" [disabled]="form().invalid || loading()">
          Save as a draft
        </button>
        <button mat-raised-button color="primary" (click)="submit(false)" [disabled]="form().invalid || loading()">
Publish now        </button>
      </div>
    </form>
  }
</div>